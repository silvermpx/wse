name: Release

on:
  push:
    tags:
      - 'v*'

permissions: {}

env:
  CARGO_INCREMENTAL: 0

jobs:
  # ---------------------------------------------------------------------------
  # Build wheels for all platforms
  # ---------------------------------------------------------------------------
  build:
    name: Build ${{ matrix.target }} (${{ matrix.os }})
    runs-on: ${{ (matrix.os == 'linux' && 'ubuntu') || matrix.os }}-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: linux
            target: x86_64-unknown-linux-gnu
            manylinux: auto

          # Linux aarch64
          - os: linux
            target: aarch64-unknown-linux-gnu
            manylinux: auto

          # macOS x86_64 (Intel)
          - os: macos
            target: x86_64-apple-darwin

          # macOS arm64 (Apple Silicon)
          - os: macos
            target: aarch64-apple-darwin

          # Windows x86_64
          - os: windows
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Setup QEMU (for cross-compilation)
        if: matrix.os == 'linux' && matrix.target == 'aarch64-unknown-linux-gnu'
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130  # v3.7.0

      - name: Build wheels
        uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021  # v1.50.0
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux || 'auto' }}
          args: --release --out dist --find-interpreter
          sccache: ${{ matrix.os != 'windows' }}

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.target }}
          path: dist/*.whl

  # ---------------------------------------------------------------------------
  # Build source distribution
  # ---------------------------------------------------------------------------
  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - uses: PyO3/maturin-action@b1bd829e37fef14c63f19162034228a2f3dc1021  # v1.50.0
        with:
          command: sdist
          args: --out dist

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: sdist
          path: dist/*.tar.gz

  # ---------------------------------------------------------------------------
  # Test built wheels on multiple platforms
  # ---------------------------------------------------------------------------
  test:
    name: Test ${{ matrix.os }} (Python ${{ matrix.python }})
    needs: build
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            python: '3.12'
            target: linux-x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            python: '3.13'
            target: linux-x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            python: '3.14'
            target: linux-x86_64-unknown-linux-gnu
          - os: macos-14
            python: '3.12'
            target: macos-aarch64-apple-darwin
          - os: windows-latest
            python: '3.12'
            target: windows-x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: ${{ matrix.python }}

      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: wheels-${{ matrix.target }}
          path: dist/

      - name: Install wheel + test deps
        shell: bash
        run: |
          pip install dist/*.whl
          pip install pytest pytest-asyncio httpx

      - name: Run tests
        shell: bash
        run: |
          rm -rf wse_server/
          pytest tests/ -v --tb=short

  # ---------------------------------------------------------------------------
  # Publish to PyPI (trusted publishing via OIDC)
  # ---------------------------------------------------------------------------
  publish:
    name: Publish to PyPI
    needs: [build, sdist, test]
    runs-on: ubuntu-latest
    environment:
      name: release
      url: https://pypi.org/project/wse-server/
    permissions:
      id-token: write
      contents: write

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          path: dist/
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.13.0
        with:
          packages-dir: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          generate_release_notes: true
          files: dist/*

  # ---------------------------------------------------------------------------
  # Build + test + publish wse-client (Python) to PyPI
  # ---------------------------------------------------------------------------
  publish-python-client:
    name: Publish Python Client to PyPI
    needs: [publish]
    runs-on: ubuntu-latest
    environment:
      name: release
      url: https://pypi.org/project/wse-client/
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install build tools + test deps
        run: pip install build pytest pytest-asyncio

      - name: Install package + optional deps
        run: pip install -e "python-client[all]"

      - name: Run tests
        run: pytest python-client/tests/ -v --tb=short

      - name: Build sdist + wheel
        run: python -m build python-client/ --outdir python-client-dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # v1.13.0
        with:
          packages-dir: python-client-dist/

  # ---------------------------------------------------------------------------
  # Publish wse-client to npm
  # ---------------------------------------------------------------------------
  publish-npm:
    name: Publish to npm
    needs: [publish]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Sync version from tag
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          npm version "$TAG" --no-git-tag-version --allow-same-version

      - name: Publish to npm
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
